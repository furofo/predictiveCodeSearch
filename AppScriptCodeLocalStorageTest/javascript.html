<script>
  // let link; // global link variable
   //changes color and makes table for collectable codes
      let collectableColor = function(collectable) {
          if (collectable == 'Collectable') {
              return "<td style = 'color: #32CD32'>" + collectable +"</td>";
          }
          else {
              return "<td style = 'color: red'>" + collectable +"</td>";
          }
      }
  
  
      // this is function used to display Header Element that Seapartes Dictoinary Elements
      let displayHeading = function(str) {
          //define header element
          heading = "<h1>" + str + "</h1>";
          nodey = document.createElement("DIV");
          nodey.setAttribute("class", "divcenter heading subheading");
          nodey.setAttribute("id", "sub");
          nodey.innerHTML = heading;
          document.body.appendChild(nodey);
      }
  
  
      //removes slashes from input
      function removeSlash(str) {
          let strWithoutSlash = '';
          for(let i = 0; i < str.length; i++) {
              if(str[i] != '/') {
                  strWithoutSlash += str[i];
              }
          }
          return strWithoutSlash;
      }
      
  
      
  
  function copyKonamiCode() {
          var copyText = document.getElementById("konamiText");
         copyText.select();
         copyText.setSelectionRange(0, 99999); 
         document.execCommand("copy");  
  
      }
  
      function fixItCode() {
         var copyText = document.getElementById("fixItText");
         copyText.select();
         copyText.setSelectionRange(0, 99999); 
         document.execCommand("copy");  
  
      }
  
      function breakItCode() {
         var copyText = document.getElementById("breakItCode");
         copyText.select();
         copyText.setSelectionRange(0, 99999); 
         document.execCommand("copy");  
  
      }
  
     
  
      function closeAllLists() {
                      var x = document.getElementsByClassName("autocomplete-items");
                      while(x[0]) {
                          x[0].parentNode.removeChild(x[0]);
                      }
                      return false;  
              }
  
      function autocomplete(inp) { 
          document.onkeydown = function(e) {
          e = e || window.event;
          switch(e.which || e.keyCode) {
              case 13:
              lookupCode();
              break;
          }
      }
          var currentFocus;
          document.addEventListener("click", function (e) {
          closeAllLists();
              });
          inp.addEventListener("input", function(e) {
              
          //variables we use throughout code will go here
              var a, b, i, val = this.value;
              closeAllLists();
              if (!val) { return false;}
              // array to hold all keys
              let combinedKeys = []; 
              for(let i = 0; i < combinedDict.length; i++) {
                  combinedKeys.push(Object.keys(combinedDict[i]["CODES"]));
              }
              currentFocus = -1;
              for (let i = 0; i < combinedKeys.length; i++) {
                  for(let j =  0; j < combinedKeys[i].length; j++) {
                     if(combinedKeys[i][j].substr(0, val.length).toUpperCase() == val.toUpperCase()) { 
                      let key = combinedKeys[i][j];
                      b = document.createElement("DIV");
                      /*make the matching letters bold:*/
                      b.setAttribute("class", "divcenter autocomplete-items");
                      b.setAttribute("id", this.id + "autocomplete-list");
                      wrapper = document.getElementById("searchbarWrapper");
                      c = document.createElement("DIV");
                      c.setAttribute("class", "center predictiveText");
                      c.innerHTML = "<strong>" + combinedKeys[i][j].substr(0, val.length) + "</strong>";
                      c.innerHTML += combinedKeys[i][j].substr(val.length);
                      //b.setAttribute("class", "center");
                      //this.parentNode.appendChild(b);
                      for (let k = 0; k < combinedDict.length; k++) {
                          if(combinedDict[k]['CODES'].hasOwnProperty(key)) {
                              c.innerHTML += combinedDict[k]["HEADING"];
                          }
                      }
  
          
                      c.innerHTML += "<input type='hidden' value='" + combinedKeys[i][j] + "'>";
                      c.addEventListener("click", function(e) {
                          inp.value = this.getElementsByTagName("input")[0].value;
                          
                          lookupCode(inp.value);
                          
  
                      })
                      wrapper.appendChild(b);
                      b.appendChild(c);
  
  
                     }
                  }
              
  
              }
       });
  
       inp.addEventListener("keydown", function(e) {
        
        var x = document.getElementById("searchbarWrapper");
        if (x) {
          x = x.getElementsByTagName("div");
      }; 
        if (e.keyCode == 40) {
          /*If the arrow DOWN key is pressed,
          increase the currentFocus variable:*/
          currentFocus+=2;
          /*and and make the current item more visible:*/
          addActive(x);
        } else if (e.keyCode == 38) { //up
          /*If the arrow UP key is pressed,
          decrease the currentFocus variable:*/
          currentFocus-=2;
          /*and and make the current item more visible:*/
          addActive(x);
        } else if (e.keyCode == 13) {
          /*If the ENTER key is pressed, prevent the form from being submitted,*/
          e.preventDefault();
          if (currentFocus > -1) {
            /*and simulate a click on the "active" item:*/
            if (x) x[currentFocus].click();
          }
        }
      function removeActive(x) {
      /*a function to remove the "active" class from all autocomplete items:*/
      for (var i = 0; i < x.length; i++) {
        x[i].classList.remove("autocomplete-active");
      }
    }
      function addActive(x) {
      /*a function to classify an item as "active":*/
      if (!x) return false;
      /*start by removing the "active" class on all items:*/
      removeActive(x);
      
      if (currentFocus > x.length) currentFocus = 1;
      if (currentFocus < 0) currentFocus = (x.length - 1);
      /*add class "autocomplete-active":*/
      x[currentFocus].classList.add("autocomplete-active");
    }
  
    
    }); 
      }
      function removeLookupCode() {
          while(document.getElementById("sub")) { // remove all elments created earlier when button clicked
              document.getElementById("sub").remove();
          }
      }
      function lookupCode() {
          closeAllLists();
          removeLookupCode();
          // variables we use throughout code will go here
          console.log("is this where erro happesn");
          let inputValue = document.getElementById("input").value.toUpperCase();
          console.log("is erro")
          let heading;
          let nodey;
          // go through all call dictonaries and see if input is a key in them display key and meaning if so
          for(let i = 0; i < combinedDict.length; i++) {
              
              if(combinedDict[i]["CODES"].hasOwnProperty(inputValue)) {
                  combinedDict[i].DISPLAYCODE(inputValue);
              }  
          }
      }
      //dictionaries to look through will go here
      let combinedDict = [];
  
  
      //google script starts here
      //used as temp array of objects add display function code once we get codes
       let googleDict = [];
         /* 
         This is function that loops through googleDict and pushes it into master dictionary for use wiht code
         
         */
        let restofCode = function() {
        let buttonsDeleted = 0;
        for (let i = 0; i < googleDict.length; i++) {
          //see if this is button setup sheet for custom buttons if it isnt add it to the other autocmplete logic if it is update values to buttons
          if(googleDict[i]['HEADING'] == 'BUTTONSETUP') {
           
             console.log(googleDict[i]);
               console.log(googleDict[i]['KONAMI']);
              if (googleDict[i].hasOwnProperty('KONAMI')) {
                
              
              //variables for buttons
               let konamiButton = document.getElementById("konamiButton");
               let konamiText = document.getElementById("konamiText");
               if(!googleDict[i]["KONAMI"]["VISIBLE"]) {
                 konamiButton.remove();
                 konamiText.remove();
                 buttonsDeleted += 1;
 
               }
 
               else {
                  // values for buttons
               konamiButton.innerText=googleDict[i]['KONAMI']['TEXT'];
               konamiText.value = googleDict[i]['KONAMI']['VALUE'];
               }
              
                }
 
               if (googleDict[i].hasOwnProperty('FIXIT')) {
               //variables for buttons
               let fixItButton = document.getElementById("fixItButton");
               let fixItText = document.getElementById("fixItText");
 
 
               if(!googleDict[i]["FIXIT"]["VISIBLE"]) {
                   fixItButton.remove();
                   fixItText.remove();
                   buttonsDeleted += 1;
               }
 
               else {
                 // values for buttons
               fixItButton.innerText= googleDict[i]['FIXIT']['TEXT'];
               fixItText.value = googleDict[i]['FIXIT']['VALUE'];
               }
               
               }
            
             if (googleDict[i].hasOwnProperty('BREAKIT')) {
              //variables for buttons
               let breakItButton = document.getElementById("breakItButton");
               let breakItText = document.getElementById("breakItCode");
 
 
 
 
               if(!googleDict[i]["BREAKIT"]["VISIBLE"]) {
                 breakItButton.remove();
                 breakItText.remove();
                 buttonsDeleted += 1;
               }
 
               else {
                   //values for buttons
               breakItButton.innerText = googleDict[i]['BREAKIT']['VALUE'];
               breakItText.value = googleDict[i]['BREAKIT']['VALUE'];
               }
 
 
               if(buttonsDeleted == 3) {
                 buttonsDeleted = 0;
                 document.getElementsByClassName("btnWrapper")[0].remove();
                 document.getElementsByClassName("heading")[2].remove();
               }
               
            }
 
            
           
        
          }
          else {
             combinedDict.push(googleDict[i]);
          }
          
        
        
      }
        }
      function onFailure(failureStr) {
        let linkedURL = localStorage.getItem("googleSheetLink");
        let b = document.createElement("DIV");
        b.setAttribute("class", "divcenter noSheetLinked");
        b.innerHTML = "<p>Google Sheet did not connect</p>";
        
 
        let c = document.createElement("DIV");
        c.setAttribute("class", "divcenter noSheetLinked");
        c.innerHTML = "<p>Current Linked Sheet URL: " +  "<span style = 'color:blue'>" + linkedURL  + "</span>" + "</p>";
 
        let d = document.createElement("DIV");
        d.setAttribute("class", "divcenter noSheetLinked");
        d.innerHTML = "<p>Refresh Page or Check url is in correct format and go to <a id = 'setupLink'>Setup</a> page to update. </p>";
 
        wrapper = document.getElementById("searchbarWrapper");
        wrapper.appendChild(b);
        wrapper.appendChild(c);
        wrapper.appendChild(d);
        let linkyFunct = function (){
            let fullUrl;
      let params = "?page=setup"
        if(!localStorage.getItem('fullURL')) {
        localStorage.setItem('fullURL', url);
        fullUrl = url + params;
          
          
          console.log(localStorage.getItem('fullURL'));
          window.open(fullUrl, '_top');
          }
          window.open(localStorage.getItem('fullURL') + params, '_top');
        }
        let linky = document.getElementById('setupLink');
        linky.onclick = linkyFunct;
        window.scrollBy(0, 400);
      }
      /*
  
      This function is call back function for google app scripts when succesfully connects. It returns an object with propertyies HEADING and CODES, since google prohibits returnign functions will loop through after returned to add necessary display code function. Code should work with predefined dictionaries regardless if connects to google app scripts or not
      */
        function onSuccess(cloneObj) { 
          console.log("on success ran!");
         googleDict = cloneObj; 
         for (let i = 0; i < googleDict.length; i++) {
            if(googleDict[i]['HEADING'] == "ButtonSetup") {
               console.log('Button Setup Found!!');
             }
           else {
           googleDict[i]['DISPLAYCODE'] = function(key) {
            
                displayHeading(googleDict[i]['HEADING']);
                let htmlToDisplay = document.createElement("DIV");
                
                 htmlToDisplay.innerHTML = "<h3>" + key + ":</h3><p class = 'listMarginLeft'>" + googleDict[i]["CODES"][key]["DEF"] + "</p>";
                if(googleDict[i]['CODES'][key].hasOwnProperty('ISCLICKABLE')) {
                    htmlToDisplay.setAttribute("class", "center isClickable");
                    htmlToDisplay.innerHTML = "<a target = '_blank' class = 'center clickableAElement' href = '" +googleDict[i]['CODES'][key]["ISCLICKABLE"] +"'>" + "<h3>" + key + ":</h3><p class = 'listMarginLeft'>" + googleDict[i]["CODES"][key]["DEF"] + "</p>" + "</a>";
                }
                else {
                  htmlToDisplay.setAttribute("class", "center");
                  htmlToDisplay.innerHTML = "<h3>" + key + ":</h3><p class = 'listMarginLeft'>" + googleDict[i]["CODES"][key]["DEF"] + "</p>";
                
                  }
                 
                 htmlToDisplay.setAttribute("id", "sub");
                 document.body.appendChild(htmlToDisplay);
           }
 
 
 
           }
 
 
         }
  
         /* 
         This is function that loops through returned obj's array from google app   scripts and adds the necessary display code function for custome dictionary list
         
         */
         restofCode();
         
        } 
        
        function linkToGoogleSheet () {
             // this is where if switch can go to see if has local storage vairable or not
        let locStorage = window.localStorage;
        let defaultUrl = "https://docs.google.com/spreadsheets/d/1dB2bD7SlqiocqnxrPCxbrF0hyK40Yu-_hVwQ-S6yeEc/edit#gid=515008555";
       if(locStorage.getItem("googleSheetLink")) {
        google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).userClicked(locStorage.getItem("googleSheetLink"));
       }
       else {
        console.log("no sheet linked");
    
       }
        }
        
       
      //navigation logic for menu items goes here
      let url = '';
      function returnUrl(link) {
         url = link;
      }
      google.script.run.withSuccessHandler(returnUrl).getScriptUrl();
  
      //window.onload = function() {
      let setupNavigationBar = function() {
      //define instance variables for buttons here
      console.log("setUpNavigationBarFunctionRan");
      let homeButton = document.getElementById("navbarHomeLink");
      let aboutButton = document.getElementById("navbarFirstLink");
      let howToButton = document.getElementById("navbarSecondLink");
      let setupButton = document.getElementById("navbarThirdLink");
  
  
      //button click handlers here ()
      homeButton.onclick = () => {
          let fullUrl;
          let params = "?page=index"
          if(!localStorage.getItem('fullURL')) {
 
          fullUrl = url + params;
          localStorage.setItem('fullURL', url);
          
          console.log(localStorage.getItem('fullURL'));
          window.open(fullUrl, '_top');
          }
          window.open(localStorage.getItem('fullURL') + params, '_top');
      }
  
      aboutButton.onclick = () => {
          let fullUrl;
          let params = "?page=about"
          if(!localStorage.getItem('fullURL')) {
 
             fullUrl = url + params;
          localStorage.setItem('fullURL', url);
          
          console.log(localStorage.getItem('fullURL'));
          window.open(fullUrl, '_top');
          }
          window.open(localStorage.getItem('fullURL') + params, '_top');
      }
  
      howToButton.onclick = () => {
         let fullUrl;
          let params = "?page=howTo"
         if(!localStorage.getItem('fullURL')) {
 
             fullUrl = url + params;
          localStorage.setItem('fullURL', url);
          
          console.log(localStorage.getItem('fullURL'));
          window.open(fullUrl, '_top');
          }
          window.open(localStorage.getItem('fullURL') + params, '_top');
      }
      setupButton.onclick = () => {
         let fullUrl;
         let params = "?page=setup"
        if(!localStorage.getItem('fullURL')) {
 
             fullUrl = url + params;
          localStorage.setItem('fullURL', url);
          
          console.log(localStorage.getItem('fullURL'));
          window.open(fullUrl, '_top');
          }
          window.open(localStorage.getItem('fullURL') + params, '_top');
         
      }
      }
      let setupAutoComplete = function() {
        console.log("setupAutoCompleteFunction ran");
      autocomplete(document.getElementById("input"));
    }
  </script>