<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include ('javascript'); ?>
      <?!= include('style'); ?>
      
<script>
    
    let localStorage= window.localStorage;
       function setupCloseNoSheetLinkedNodes() {
                     var x = document.getElementsByClassName("noSheetLinked");
                     while(x[0]) {
                         x[0].parentNode.removeChild(x[0]);
                     }
                     return false;  
             }
      function setupOnFailure(failureStr) {
      setupCloseNoSheetLinkedNodes()
      removeSetupMessages();
      console.log("this failed");
       let linkedURL = localStorage.getItem("googleSheetLink");
       let b = document.createElement("DIV");
       b.setAttribute("class", "divcenter noSheetLinked");
       b.innerHTML = "<p>Google Sheet did not connect</p>";
       

       let c = document.createElement("DIV");
       c.setAttribute("class", "divcenter noSheetLinked");
       c.innerHTML = "<p>Current Linked Sheet URL: " +  "<span style = 'color:blue'>" + linkedURL  + "</span>" + "</p>";

       let d = document.createElement("DIV");
       d.setAttribute("class", "divcenter noSheetLinked");
       d.innerHTML = "<p>Refresh Page or Check url is in correct format, updated in input field and click linksheet button again. </p>";

      // let wrapper = document.getElementById("setupInputLink");
       document.body.appendChild(b);
       document.body.appendChild(c);
       document.body.appendChild(d);
     }
    function isGoogleSheetLinked() {
      if(localStorage.getItem("googleSheetLink")) {
      console.log("google sheet linkded")
      console.log(localStorage.getItem("googleSheetLink"));
      return localStorage.getItem("googleSheetLink");
    }

    else {
      console.log("google sheet not lkinked")
      return null;
    }
  
    }

   
    
   function validURL(str) {
  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
  return !!pattern.test(str);
}

   let removeSetupMessages = function(){
     let x = document.getElementsByClassName("sheetLinked");
     while(x[0]) {
                        x[0].parentNode.removeChild(x[0]);
                    }
                    return false; 
   }
   
   function storeLink() {
     removeSetupMessages();
     let value;
     //check value if website link and put in local storage if is
     if(document.querySelector("#setupInput").value) {
       console.log("did this execute?");
      value = document.querySelector("#setupInput").value;
      console.log("can it read value still");
      console.log(value);
      if(value){
         console.log("how much further?")
         let  b = document.createElement("DIV");
                    /*make the matching letters bold:*/
                    b.setAttribute("class", "divcenter sheetLinked");
                    
                    b.innerHTML = "<p class = 'setupParagraph'>Google Sheet Linked!</p>";


         let c = document.createElement("DIV");
                   c.setAttribute("class", "divcenter sheetLinked blackFont");
                   c.innerHTML = "<p class = 'setupParagraph'>Current google URL linked is: </p>";
        
         let d = document.createElement("Div");
                   d.setAttribute("class", "divcenter sheetLinked blueFont");
                   d.innerHTML = "<p class = 'setupParagraph'> " + value + "</p>";



                    wrapper = document.getElementsByTagName('main');
                    wrapper[0].appendChild(b);
                    wrapper[0].appendChild(c);
                    wrapper[0].appendChild(d);
          console.log("before getting to localStorage?");
      localStorage.setItem('googleSheetLink', value);
      console.log("after local storage::");

           google.script.run.withSuccessHandler(onSuccess).withFailureHandler(setupOnFailure).userClicked(localStorage.getItem("googleSheetLink"));         
       }
       
     }
     else{
       localStorage.clear();
       let b = document.createElement("DIV");
       b.setAttribute("class", "divcenter sheetLinked redFont");
       b.innerHTML = "<p class = 'setupParagraph'>Nothing was submitted, please put</p>";

       let c = document.createElement("DIV");
       c.setAttribute("class", "divcenter sheetLinked redFont");
       c.innerHTML = "<p class = 'setupParagraph'>a valid url and click link sheet again!</p>";

       wrapper = document.getElementsByTagName('main');
       wrapper[0].appendChild(b);
       wrapper[0].appendChild(c);
     }
   
   }
   /*
   window.onload = function() {
   if(isGoogleSheetLinked()!= null) {
   let url = isGoogleSheetLinked();
   function onSuccess(row) {
   }
   google.script.run.withSuccessHandler(onSuccess).userClicked(url);
   }
   }
   */
  
   window.onload = function() {
    
       setupNavigationBar();
       let link =  isGoogleSheetLinked();
       if(link){
         let b = document.createElement("DIV");
                    /*make the matching letters bold:*/
                    b.setAttribute("class", "divcenter sheetLinked");
                    
                    b.innerHTML = "<p class = 'setupParagraph'>Google Sheet Linked!</p>";


         let c = document.createElement("DIV");
                   c.setAttribute("class", "divcenter sheetLinked blackFont");
                   c.innerHTML = "<p class = 'setupParagraph'>Current google URL linked is: </p>";
        
         let d = document.createElement("Div");
                   d.setAttribute("class", "divcenter sheetLinked blueFont");
                   d.innerHTML = "<p class = 'setupParagraph'> " + link + "</p>";



                    wrapper = document.getElementsByTagName('main');
                    wrapper[0].appendChild(b);
                    wrapper[0].appendChild(c);
                    wrapper[0].appendChild(d);
       }

       else {
          let b = document.createElement("DIV");
          b.setAttribute("class", "divcenter sheetLinked redFont");
          b.innerHTML = "<p class = 'setupParagraph'>No Google Sheet Linked</p>";
          wrapper = document.getElementsByTagName('main');
          wrapper[0].appendChild(b);
       }

     document.getElementById("setupInput").addEventListener("keydown", function (e) {
    if (e.code === "Enter") {  //checks whether the pressed key is "Enter"
        storeLink();
    }
    });
   }
  
  </script>
</head>
<main>
<body>
  <div class = "center heading">
            <h3>Copy Buttons</h3>
        </div>
  <div class = "heading navbar">
        <h3 id = "navbarHomeLink">Home</h3>
        <h3 id = "navbarFirstLink">About</h3>
        <h3 id = "navbarSecondLink">HowTo</h3>
        <h3 id = "navbarThirdLink" class = "pageSelected">Setup </h3>
        </div>
   <div class = "center heading">
            <h1>Setup Custom Sheet</h1>
        </div>
<div class = "center" id = "setupInputLink">
<input type = "text" id = "setupInput">
<button id = "setupButton" onclick = "storeLink()">Link Sheet</button>
</div>

</body>
</main>
</html>